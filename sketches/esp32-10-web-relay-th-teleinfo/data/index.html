<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html"; charset="utf-8">
    <title>Web relays</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>

      var ws;

      function ws_connect() {
        ws = new WebSocket('ws://' + location.hostname + ':81', ['arduino']);
        // ws = new WebSocket('ws://192.168.1.40:80/ws', ['arduino']);
        // ws = new WebSocket('ws://192.168.1.55:81', ['arduino']);

        ws.onopen = function () {
          console.log('Connected');
          //ws.send('Connect ' + new Date());
          //ws.send('/status');
        };
        ws.onclose = function(e) {
          console.log('Socket is closed. Reconnect will be attempted in 5 second.', e.reason);
          setTimeout(function() {
            ws_connect();
          }, 5000);
        };
        ws.onerror = function (error) {
          console.log('WebSocket Error ', error);
        };
        ws.onmessage = function (e) {
          console.log('Server: \n', e.data);
          
          const eventData = e.data.split('~');
          var eventName = eventData[0];
          var eventBody = JSON.parse(eventData[1]);

          // console.log('eventName: ', eventName);
          // console.log('eventBody: ', eventBody);
          
          if(eventName === "status") {
            $("#tableRelays tbody").children().remove()
            
            for(relay in eventBody.relays) {
              tableRelaysAdd(eventBody.relays[relay]);
            }
          } 
          
          if(eventName.startsWith("relay")) {
            // update button
            buttonImageFile = (eventBody.value == 0 ? "off.svg" : "on.svg")
            buttonImage = "<img src=\"/" + buttonImageFile +"\" height=\"40\" width=\"32\"/>"
            
            // console.log('buttonImage: \n', buttonImage);
            // console.log('id: \n', eventBody.id);
            document.getElementById("switch" + eventBody.id).innerHTML = buttonImage;
          }

          if(eventName.startsWith("sensors/th")) {
            document.getElementById("sensorsT").innerHTML = eventBody.t + " Â°C"
            document.getElementById("sensorsH").innerHTML = eventBody.h + " %"
          }

          if(eventName.startsWith("sensors/teleinfo")) {
            if(eventBody.IINST) {
              document.getElementById("teleinfoIINST").innerHTML = (Number(eventBody.IINST) * 230) + " W"
            }
            if(eventBody.PAPP) {
              document.getElementById("teleinfoPAPP").innerHTML = Number(eventBody.PAPP) + " W"
            }
            if(eventBody.HCHP) {
              document.getElementById("teleinfoHCHP").innerHTML = Number(eventBody.HCHP) + " kWh"
            }
            if(eventBody.HCHC) {
              document.getElementById("teleinfoHCHC").innerHTML = Number(eventBody.HCHC) + " kWh"
            }
            if(eventBody.PTEC) {
              document.getElementById("teleinfoPTEC").innerHTML = Number(eventBody.PTEC)
            }
            if(eventBody.ADPS) {
              document.getElementById("teleinfoADPS").innerHTML = Number(eventBody.ADPS)
            }
            if(eventBody.HHPHC) {
              document.getElementById("teleinfoHHPHC").innerHTML = Number(eventBody.HHPHC)
            }
          }
        };
      }

      ws_connect();

      setInterval(readTH, 5000);

      function tableRelaysAdd(relay) {
        buttonImageFile = (relay.value == 0 ? "off.svg" : "on.svg")
        buttonImage = "<img src=\"/" + buttonImageFile +"\" height=\"40\" width=\"32\"/>"

        $("#tableRelays tbody").append("<tr>" +
            "<td>" + relay.description +"</td>" +
            "<td>" + 
              "<button id=\"switch" + relay.id + "\" onclick=\"relaySwitch(" + relay.id + ")\">" + 
                buttonImage +
              "</button>" +
            "</td>" +
            "</tr>");
      }
      
      function relaySwitch(id) {
        console.log('Relay: ' + id);
        ws.send('relays/set?' + id + "=-1");
      }

      function relayTest() {
        console.log('Relay Test:');
        ws.send('relays/test');
      }

      function readTH() {
        console.log('Sensor:');
        ws.send('sensors');
      }
    </script>
  </head>
  <body>
    <table id="tableGlobal">
      <thead>
        <tr>
          <th>Test</th>
          <th>Temperature</th>
          <th>Humidity</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><button id="test" onclick="relayTest()">Relay Test</button></td>
          <td id="sensorsT"></td>
          <td id="sensorsH"></td>
        </tr>
      </tbody> 
    </table>
    <table id="tableTeleinfo">
      <thead>
        <tr>
          <th>Power (I)</th>
          <th>Power (P)</th>
          <th>Cpt H.P.</th>
          <th>Cpt H.C.</th>
          <th>Periode</th>
          <th>Alert</th>
          <th>Groupe Horaire</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td id="teleinfoIINST"></td>
          <td id="teleinfoPAPP"></td>
          <td id="teleinfoHCHP"></td>
          <td id="teleinfoHCHC"></td>
          <td id="teleinfoPTEC"></td>
          <td id="teleinfoADPS"></td>
          <td id="teleinfoHHPHC"></td>
        </tr>
      </tbody> 
    </table>
    <table id="tableRelays">
      <thead>
        <tr>
          <th>Description</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
      </tbody> 
    </table>
    </br>
    
  </body>
</html>