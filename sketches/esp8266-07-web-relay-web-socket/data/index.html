<!DOCTYPE HTML>
<html>
  <head>
      <meta http-equiv="Content-type" content="text/html"; charset="utf-8">
      <title>Web relays</title>
      <link rel="stylesheet" type="text/css" href="style.css">
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
      <script>
      var connection = new WebSocket('ws://' + location.hostname + ':80/ws', ['arduino']);
      // var connection = new WebSocket('ws://192.168.1.40:80/ws', ['arduino']);
      connection.onopen = function () {
        console.log('Connected');
        //connection.send('Connect ' + new Date());
        //connection.send('/status');
      };
      connection.onerror = function (error) {
        console.log('WebSocket Error ', error);
      };
      connection.onmessage = function (e) {
        console.log('Server: \n', e.data);
        
        if(e.data.startsWith("{")) {
          var obj = JSON.parse(e.data);
          for(relay in obj.relays) {
            tableRelaysAdd(obj.relays[relay]);
          }
        } else if(e.data.startsWith("relays/status?")) {
          // update button
        }
        
      };

      function tableRelaysAdd(relay) {
        buttonImage = (relay.value == 0 ? "on.svg" : "off.svg")

        $("#tableRelays tbody").append("<tr>" +
            "<td>" + relay.description +"</td>" +
            "<td><button id=\"switch" + relay.switch + "\" onclick=\"relaySwitch(" + relay.switch + ")\">" + 
            "<img src=\"/" + buttonImage +"\" height=\"40\" width=\"32\"/></button>" +
            "</td>" +
            "</tr>");
      }
      
      function relaySwitch(id) {
        console.log('Relay: ' + id);
        connection.send('relays/set?' + id + "=-1");
      }
    </script>
  </head>
  <body>
    <table id="tableRelays">
      <thead>
        <tr>
          <th>Description</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody>
      </tbody> 
    </table>
  </body>
</html>